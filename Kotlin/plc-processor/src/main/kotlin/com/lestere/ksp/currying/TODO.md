# **工单：CurryingKspVisitor 插件优化与改进**

## **背景与目标**

* **目标**：优化 `CurryingKspVisitor` 的代码生成逻辑，提升代码的可维护性与稳定性，并扩展功能支持。
* **现状**：当前 `CurryingKspVisitor` 可以处理带 `@Currying` 注解的函数，通过 KSP 生成柯里化函数的扩展方法。

## **待优化/改进项**

### 1. **优化函数体（`visitFunctionDeclaration()`）结构**

* **问题**：`visitFunctionDeclaration()` 方法过长，包含了太多逻辑。
* **目标**：将逻辑拆分为小的、职责单一的函数，提升可读性与可维护性。
* **解决方案**：

  * 提取 **`resolvePackageName`** 函数，用于处理包名解析。
  * 提取 **`resolveCurriedFunctionTypesAndSignature`** 函数，返回 CurriedFunctionInfo（包含类型、签名等）。
  * 提取 **`generateJvmName`** 函数，生成更具唯一性的 JVM 名称。

---

### 2. **增强 JVM 名称生成唯一性**

* **问题**：当前 JVM 名称生成逻辑可能会导致冲突。
* **目标**：改进 JVM 名称生成，避免相同函数名与参数类型导致冲突。
* **解决方案**：

  * 在 JVM 名称中添加函数参数签名的哈希值。
  * 例如：`val signatureHash = arguments.joinToString(",") { it.second.typeQualifiedName() }.hashCode().toUInt().toString(16)`

---

### 3. **支持 `suspend` 或 `inline` 函数**

* **问题**：目前不支持 `suspend` 或 `inline` 函数。
* **目标**：为 `suspend` 和 `inline` 函数添加处理逻辑。
* **解决方案**：

  * 在处理函数之前，检查函数是否是 `suspend`，并记录警告或跳过生成。
  * 同时支持 `inline` 函数的生成（如果适用）。

---

### 4. **优化文件生成过程**

* **问题**：生成的 `.kt` 文件可能没有尾部换行符。
* **目标**：确保生成的文件总是以换行符结尾。
* **解决方案**：在 `writeText("\n")` 之后再加上 `"\n"`，确保格式符合标准。

---

### 5. **增加测试覆盖**

* **目标**：为 `CurryingKspVisitor` 添加单元测试与集成测试，确保生成的 `.kt` 文件符合预期。
* **解决方案**：

  * 使用 KSP 提供的测试工具，创建模拟项目并验证输出文件的正确性。
  * 通过反射或代码比较验证生成的函数是否满足柯里化规则。

---

## **任务优先级**

| 任务                      | 优先级 | 描述                                 |
| ----------------------- | --- | ---------------------------------- |
| 代码结构优化                  | 高   | 重构 `visitFunctionDeclaration()` 方法 |
| JVM 名称生成优化              | 中   | 改进 JVM 名称唯一性                       |
| `suspend` 和 `inline` 支持 | 中   | 处理 `suspend` 和 `inline` 函数         |
| 文件生成优化                  | 低   | 确保文件生成正确的换行符                       |
| 测试覆盖                    | 高   | 增加单元测试和集成测试                        |

---

## **实施步骤**

1. **重构 `visitFunctionDeclaration()` 方法**

   * 提取出小函数，保证每个函数只做一件事。
2. **改进 JVM 名称生成**

   * 引入函数参数签名的哈希值，提升 JVM 名称唯一性。
3. **支持 `suspend` 和 `inline` 函数**

   * 在解析函数时，增加对 `suspend` 和 `inline` 的检查与处理。
4. **修复文件生成换行符问题**

   * 修改文件写入逻辑，确保文件始终以换行符结尾。
5. **增加测试**

   * 使用 KSP 提供的测试工具，覆盖功能测试，验证输出的正确性。

---

## **预计完成时间**

* 代码重构：2-3 天
* JVM 名称优化：1 天
* `suspend` 和 `inline` 支持：2 天
* 文件换行修复：0.5 天
* 测试覆盖：2 天

---

## **后续计划**

* 确保测试环境稳定，特别是在大规模项目中进行验证。
* 在生产环境中上线后，持续监控插件运行的效果。
* 增加更多的注解和处理能力，支持更复杂的函数签名。
